<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>RideKada - Upload Documents</title>
  <link rel="stylesheet" href="css/driver_dashboard.css">
</head>
<body>

  <!-- Navigation -->
  <nav class="navbar">
    <div class="logo-section">
      <img src="media/logo.png" alt="RideKada Logo" class="logo-circle">
      <span class="brand-name">RideKada</span>
    </div>

    <div class="user-section">
      <button class="action-btn primary" onclick="window.location.href='driver_dashboard.html'">
        ‚Üê Back to Dashboard
      </button>
      <div class="profile-wrapper">
        <div id="userIcon" class="user-icon">üë§</div>
        <div id="profileDropdown" class="profile-dropdown">
          <a href="profile.html" class="dropdown-item">View Profile</a>
          <a href="#" id="logoutLink" class="dropdown-item">Logout</a>
        </div>
      </div>
    </div>
  </nav>

  <!-- Main Content -->
  <div class="documents-page">
    <h1 class="page-title">üìÑ Document Management</h1>
    <p class="page-subtitle">Upload and manage your driver's license, vehicle registration, and other required documents.</p>

    <div class="info-alert">
      ‚ÑπÔ∏è <strong>Important:</strong> Please upload clear, readable copies of your documents. Accepted formats: JPG, PNG, PDF (max 5MB per file). Documents will be reviewed by admin for verification.
    </div>

    <div id="alertContainer"></div>

    <!-- Upload Section -->
    <div class="upload-section">
      <div class="section-header">
        <h2 class="section-title">Upload New Document</h2>
      </div>

      <form id="uploadForm" class="upload-form">
        <div class="form-group">
          <label for="documentType">Document Type *</label>
          <select id="documentType" name="documentType" required>
            <option value="">-- Select Document Type --</option>
            <option value="License">Driver's License</option>
            <option value="VehicleRegistration">Vehicle Registration (OR/CR)</option>
            <option value="Insurance">Vehicle Insurance</option>
            <option value="Other">Other Document</option>
          </select>
        </div>

        <div class="form-group">
          <label>Select File *</label>
          <div class="file-input-wrapper">
            <label for="documentFile" class="file-input-button" id="fileInputButton">
              <span class="file-icon">üìÅ</span>
              <span class="file-input-text">Click to select file or drag and drop</span>
              <span class="file-input-subtext">Supported: JPG, PNG, PDF (Max 5MB)</span>
            </label>
            <input type="file" id="documentFile" name="document" accept=".jpg,.jpeg,.png,.pdf" required>
            <div id="fileNameDisplay" class="file-name-display" style="display: none;"></div>
          </div>
        </div>

        <button type="submit" class="btn-upload" id="uploadButton">
          üì§ Upload Document
        </button>
      </form>
    </div>

    <!-- Documents List -->
    <div class="upload-section">
      <div class="section-header">
        <h2 class="section-title">My Documents</h2>
        <button class="btn-view" onclick="loadDocuments()">üîÑ Refresh</button>
      </div>

      <div id="documentsList" class="documents-list">
        <div class="no-documents">
          <div class="no-documents-icon">üìÑ</div>
          <p>Loading documents...</p>
        </div>
      </div>
    </div>
  </div>

  <script>
    let currentDriver = null;

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      currentDriver = getStoredUser();
      
      if (!currentDriver || currentDriver.UserType !== 'Driver') {
        alert('Please login as a driver to access this page');
        window.location.href = 'index.html';
        return;
      }

      setupProfileDropdown();
      setupFileInput();
      setupUploadForm();
      loadDocuments();
    });

    function getStoredUser() {
      try {
        const data = sessionStorage.getItem('user');
        return data ? JSON.parse(data) : null;
      } catch (e) {
        console.error('Failed to parse user', e);
        return null;
      }
    }

    function setupProfileDropdown() {
      const userIcon = document.getElementById('userIcon');
      const dropdown = document.getElementById('profileDropdown');
      const logoutLink = document.getElementById('logoutLink');

      if (userIcon && dropdown) {
        userIcon.addEventListener('click', (e) => {
          e.stopPropagation();
          dropdown.classList.toggle('show');
        });
      }

      if (logoutLink) {
        logoutLink.addEventListener('click', (e) => {
          e.preventDefault();
          if (confirm('Logout?')) {
            sessionStorage.removeItem('user');
            window.location.href = 'index.html';
          }
        });
      }

      document.addEventListener('click', (e) => {
        if (!userIcon?.contains(e.target) && !dropdown?.contains(e.target)) {
          dropdown?.classList.remove('show');
        }
      });
    }

    function setupFileInput() {
      const fileInput = document.getElementById('documentFile');
      const fileButton = document.getElementById('fileInputButton');
      const fileDisplay = document.getElementById('fileNameDisplay');

      fileInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        
        if (file) {
          // Check file size (5MB)
          if (file.size > 5 * 1024 * 1024) {
            showAlert('File size exceeds 5MB limit', 'error');
            fileInput.value = '';
            return;
          }

          // Check file type
          const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'application/pdf'];
          if (!allowedTypes.includes(file.type)) {
            showAlert('Invalid file type. Only JPG, PNG, and PDF are allowed.', 'error');
            fileInput.value = '';
            return;
          }

          fileButton.classList.add('has-file');
          fileDisplay.textContent = `Selected: ${file.name} (${formatFileSize(file.size)})`;
          fileDisplay.style.display = 'block';
        } else {
          fileButton.classList.remove('has-file');
          fileDisplay.style.display = 'none';
        }
      });
    }

    function setupUploadForm() {
      const form = document.getElementById('uploadForm');
      
      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const documentType = document.getElementById('documentType').value;
        const fileInput = document.getElementById('documentFile');
        const file = fileInput.files[0];
        
        if (!documentType || !file) {
          showAlert('Please select document type and file', 'error');
          return;
        }

        const uploadButton = document.getElementById('uploadButton');
        const originalText = uploadButton.textContent;
        uploadButton.disabled = true;
        uploadButton.textContent = '‚è≥ Uploading...';

        const formData = new FormData();
        formData.append('driverId', currentDriver.DriverID);
        formData.append('documentType', documentType);
        formData.append('document', file);

        try {
          const response = await fetch('php/upload_document.php', {
            method: 'POST',
            body: formData
          });

          const data = await response.json();

          if (data.success) {
            showAlert(`‚úÖ ${data.message}`, 'success');
            form.reset();
            document.getElementById('fileInputButton').classList.remove('has-file');
            document.getElementById('fileNameDisplay').style.display = 'none';
            loadDocuments();
          } else {
            showAlert(`‚ùå ${data.message}`, 'error');
          }
        } catch (error) {
          console.error('Upload error:', error);
          showAlert('Failed to upload document. Please try again.', 'error');
        } finally {
          uploadButton.disabled = false;
          uploadButton.textContent = originalText;
        }
      });
    }

    async function loadDocuments() {
      const container = document.getElementById('documentsList');
      container.innerHTML = '<div class="no-documents"><div class="no-documents-icon">‚è≥</div><p>Loading documents...</p></div>';

      console.log('Loading documents for driver:', currentDriver.DriverID);

      try {
        const url = `php/get_driver_documents.php?driverId=${currentDriver.DriverID}`;
        console.log('Fetching from:', url);
        
        const response = await fetch(url);
        console.log('Response status:', response.status);
        
        const data = await response.json();
        console.log('Response data:', data);

        if (data.success) {
          if (data.documents.length === 0) {
            container.innerHTML = `
              <div class="no-documents">
                <div class="no-documents-icon">üìÑ</div>
                <p><strong>No documents uploaded yet</strong></p>
                <p style="color:#999; font-size:14px; margin-top:10px;">Upload your driver's license and vehicle registration to get started.</p>
              </div>
            `;
            return;
          }

          container.innerHTML = data.documents.map(doc => {
            const docTypeLabels = {
              'License': 'ü™™ Driver\'s License',
              'VehicleRegistration': 'üöó Vehicle Registration',
              'Insurance': 'üìã Insurance',
              'Other': 'üìÑ Other Document'
            };

            const statusClass = doc.status.toLowerCase();
            const uploadDate = new Date(doc.uploadedAt).toLocaleDateString('en-US', {
              year: 'numeric',
              month: 'short',
              day: 'numeric'
            });

            return `
              <div class="document-card ${statusClass}">
                <div class="document-info">
                  <div class="document-type">${docTypeLabels[doc.documentType] || doc.documentType}</div>
                  <div class="document-details">
                    <div class="document-meta">üìÅ ${doc.fileName}</div>
                    <div class="document-meta">üìè ${formatFileSize(doc.fileSize)}</div>
                    <div class="document-meta">üìÖ ${uploadDate}</div>
                  </div>
                  ${doc.rejectionReason ? `
                    <div class="rejection-reason">
                      <strong>‚ùå Rejection Reason:</strong> ${doc.rejectionReason}
                    </div>
                  ` : ''}
                </div>
                <div class="document-actions">
                  <span class="document-status ${statusClass}">${doc.status}</span>
                  <button class="btn-view" onclick="viewDocument('${doc.filePath}')">üëÅÔ∏è View</button>
                  <button class="btn-delete" onclick="deleteDocument(${doc.documentId})">üóëÔ∏è Delete</button>
                </div>
              </div>
            `;
          }).join('');
        } else {
          console.error('Load failed:', data.message, data.debug);
          
          // Show detailed error to user
          container.innerHTML = `
            <div class="no-documents">
              <div class="no-documents-icon">‚ö†Ô∏è</div>
              <p style="color:#e74c3c;"><strong>Error: ${data.message}</strong></p>
              ${data.debug ? `<p style="color:#999; font-size:13px; margin-top:10px;">${data.debug}</p>` : ''}
              ${data.action ? `<p style="color:#2196f3; font-size:13px; margin-top:10px;"><strong>Action needed:</strong> ${data.action}</p>` : ''}
            </div>
          `;
        }
      } catch (error) {
        console.error('Load documents error:', error);
        container.innerHTML = `
          <div class="no-documents">
            <div class="no-documents-icon">‚ö†Ô∏è</div>
            <p style="color:#e74c3c;"><strong>Error loading documents</strong></p>
            <p style="color:#999; font-size:13px; margin-top:10px;">${error.message}</p>
            <p style="color:#2196f3; font-size:13px; margin-top:10px;">Check browser console (F12) for details</p>
          </div>
        `;
      }
    }

    function viewDocument(filePath) {
      window.open(filePath, '_blank');
    }

    async function deleteDocument(documentId) {
      if (!confirm('Are you sure you want to delete this document?')) {
        return;
      }

      try {
        const response = await fetch('php/delete_document.php', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify({
            documentId: documentId,
            driverId: currentDriver.DriverID
          })
        });

        const data = await response.json();

        if (data.success) {
          showAlert('‚úÖ Document deleted successfully', 'success');
          loadDocuments();
        } else {
          showAlert('‚ùå Failed to delete document', 'error');
        }
      } catch (error) {
        console.error('Delete error:', error);
        showAlert('‚ùå Failed to delete document', 'error');
      }
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function showAlert(message, type) {
      const container = document.getElementById('alertContainer');
      const alertClass = type === 'error' ? 'error-alert' : type === 'success' ? 'success-alert' : 'info-alert';
      
      container.innerHTML = `<div class="${alertClass}">${message}</div>`;
      
      setTimeout(() => {
        container.innerHTML = '';
      }, 5000);
    }
  </script>

</body>
</html>